# ==============================================================================
# Railway Deployment Makefile
# ==============================================================================
#
# Shortcuts for common Railway operations.
#
# Usage:
#   make -f Makefile.railway <target>
#
# Or create alias in your ~/.bashrc or ~/.zshrc:
#   alias railway-make='make -f Makefile.railway'
#
# Then use:
#   railway-make setup
#   railway-make deploy
#   railway-make logs
#
# ==============================================================================

.PHONY: help setup deploy logs logs-errors logs-db status backup restore open variables restart

# Default target - show help
help:
	@echo "Railway Deployment Commands"
	@echo "============================"
	@echo ""
	@echo "Setup & Deployment:"
	@echo "  make -f Makefile.railway setup        Initial Railway project setup"
	@echo "  make -f Makefile.railway deploy       Deploy to Railway"
	@echo ""
	@echo "Monitoring:"
	@echo "  make -f Makefile.railway logs         Stream all logs"
	@echo "  make -f Makefile.railway logs-errors  Stream error logs only"
	@echo "  make -f Makefile.railway logs-db      Stream database logs"
	@echo "  make -f Makefile.railway status       Show deployment status"
	@echo ""
	@echo "Database:"
	@echo "  make -f Makefile.railway backup       Backup database"
	@echo "  make -f Makefile.railway restore      Restore database (requires BACKUP_FILE)"
	@echo ""
	@echo "Utilities:"
	@echo "  make -f Makefile.railway open         Open Railway dashboard"
	@echo "  make -f Makefile.railway variables    List environment variables"
	@echo "  make -f Makefile.railway restart      Restart Railway service"
	@echo ""
	@echo "Examples:"
	@echo "  make -f Makefile.railway backup"
	@echo "  make -f Makefile.railway restore BACKUP_FILE=railway-backups/backup-20251106.sqlite"
	@echo ""
	@echo "Tip: Create alias for easier use:"
	@echo "  alias railway-make='make -f Makefile.railway'"
	@echo ""

# ==============================================================================
# Setup & Deployment
# ==============================================================================

setup:
	@echo "ğŸš€ Running Railway setup..."
	@./scripts/railway-setup.sh

deploy:
	@echo "ğŸ“¦ Deploying to Railway..."
	@./scripts/deploy-to-railway.sh

# ==============================================================================
# Monitoring
# ==============================================================================

logs:
	@echo "ğŸ“œ Streaming logs..."
	@./scripts/railway-logs.sh

logs-errors:
	@echo "ğŸš¨ Streaming error logs..."
	@./scripts/railway-logs.sh --errors

logs-db:
	@echo "ğŸ—„ï¸  Streaming database logs..."
	@./scripts/railway-logs.sh --database

logs-migrations:
	@echo "ğŸ”„ Streaming migration logs..."
	@./scripts/railway-logs.sh --migrations

logs-git:
	@echo "ğŸ“š Streaming git logs..."
	@./scripts/railway-logs.sh --git

status:
	@echo "ğŸ“Š Railway deployment status:"
	@echo ""
	@railway status
	@echo ""
	@echo "Deployment URL:"
	@railway domain || echo "Not available"

# ==============================================================================
# Database Operations
# ==============================================================================

backup:
	@echo "ğŸ’¾ Backing up database..."
	@./scripts/railway-backup-db.sh

restore:
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "âŒ Error: BACKUP_FILE required"; \
		echo ""; \
		echo "Usage:"; \
		echo "  make -f Makefile.railway restore BACKUP_FILE=path/to/backup.sqlite"; \
		echo ""; \
		exit 1; \
	fi
	@echo "â™»ï¸  Restoring database..."
	@./scripts/railway-restore-db.sh $(BACKUP_FILE)

# ==============================================================================
# Utilities
# ==============================================================================

open:
	@echo "ğŸŒ Opening Railway dashboard..."
	@railway open

variables:
	@echo "ğŸ“ Environment variables:"
	@echo ""
	@railway variables

restart:
	@echo "ğŸ”„ Restarting Railway service..."
	@railway service restart || railway restart || echo "Restart not supported, redeploy instead"

# ==============================================================================
# Advanced Operations
# ==============================================================================

shell:
	@echo "ğŸš Opening Railway shell..."
	@railway shell || echo "Shell not available for this service"

volumes:
	@echo "ğŸ’¾ Listing Railway volumes..."
	@railway volume list

link:
	@echo "ğŸ”— Linking to Railway project..."
	@railway link

whoami:
	@echo "ğŸ‘¤ Current Railway user:"
	@railway whoami

# ==============================================================================
# Development Shortcuts
# ==============================================================================

check-types:
	@echo "ğŸ” Checking TypeScript types..."
	@pnpm run generate-types:check

update-types:
	@echo "ğŸ”„ Regenerating TypeScript types..."
	@pnpm run generate-types

test:
	@echo "ğŸ§ª Running tests..."
	@pnpm run check

# ==============================================================================
# Quick Deploy (checks + deploy)
# ==============================================================================

quick-deploy: check-types
	@echo "ğŸš€ Quick deploy (with type check)..."
	@./scripts/deploy-to-railway.sh

# ==============================================================================
# Emergency Operations
# ==============================================================================

emergency-backup:
	@echo "ğŸš¨ EMERGENCY BACKUP"
	@echo "Creating timestamped backup..."
	@./scripts/railway-backup-db.sh --output "emergency-backup-$$(date +%Y%m%d-%H%M%S).sqlite"
	@echo ""
	@echo "âœ… Emergency backup created"

# ==============================================================================
# Info & Diagnostics
# ==============================================================================

info:
	@echo "â„¹ï¸  Railway Project Information"
	@echo "=============================="
	@echo ""
	@echo "Project Status:"
	@railway status
	@echo ""
	@echo "Deployment URL:"
	@railway domain || echo "Not available"
	@echo ""
	@echo "Recent Deployments:"
	@railway deployments || echo "Not available"
	@echo ""
	@echo "Environment Variables:"
	@railway variables | head -10
	@echo ""
	@echo "Volumes:"
	@railway volume list || echo "Not available"
