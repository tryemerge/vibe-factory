use std::{env, fs, path::Path};

use executors::executors::CodingAgentExecutorType;
use services::services::config::{
    Config, EditorConfig, EditorConstants, EditorType, EnvironmentInfo, GitHubConfig,
    SoundConstants, SoundFile, ThemeMode,
};
use ts_rs::TS;

type DeploymentImpl = local_deployment::LocalDeployment;

fn generate_types_content() -> String {
    // 4. Friendly banner
    const HEADER: &str = "// This file was generated by `crates/core/src/bin/generate_types.rs`.\n
// Do not edit this file manually.\n
// If you are an AI, and you absolutely have to edit this file, please confirm with the user first.";

    let decls: Vec<String> = vec![
        services::services::filesystem::DirectoryEntry::decl(),
        services::services::filesystem::DirectoryListResponse::decl(),
        db::models::project::Project::decl(),
        db::models::project::ProjectWithBranch::decl(),
        db::models::project::CreateProject::decl(),
        db::models::project::UpdateProject::decl(),
        db::models::project::SearchResult::decl(),
        db::models::project::SearchMatchType::decl(),
        // UserSystemInfo::decl(),
        // Environment::decl(),
        Config::decl(),
        EnvironmentInfo::decl(),
        ThemeMode::decl(),
        EditorConfig::decl(),
        EditorType::decl(),
        EditorConstants::decl(),
        GitHubConfig::decl(),
        SoundFile::decl(),
        SoundConstants::decl(),
        CodingAgentExecutorType::decl(),
    ];

    let body = decls
        .into_iter()
        .map(|d| {
            let trimmed = d.trim_start();
            if trimmed.starts_with("export") {
                d
            } else {
                format!("export {trimmed}")
            }
        })
        .collect::<Vec<_>>()
        .join("\n\n");

    format!("{HEADER}\n\n{body}")
}

fn main() {
    let args: Vec<String> = env::args().collect();
    let check_mode = args.iter().any(|arg| arg == "--check");

    // 1. Make sure ../shared exists
    let shared_path = Path::new("shared");
    fs::create_dir_all(shared_path).expect("cannot create shared");

    println!("Generating TypeScript types…");

    // 2. Let ts-rs write its per-type files here (handy for debugging)
    env::set_var("TS_RS_EXPORT_DIR", shared_path.to_str().unwrap());

    let generated = generate_types_content();
    let types_path = shared_path.join("types.ts");

    if check_mode {
        // Read the current file
        let current = fs::read_to_string(&types_path).unwrap_or_default();
        if current == generated {
            println!("✅ shared/types.ts is up to date.");
            std::process::exit(0);
        } else {
            eprintln!("❌ shared/types.ts is not up to date. Please run 'npm run generate-types' and commit the changes.");
            std::process::exit(1);
        }
    } else {
        // Write the file as before
        fs::write(&types_path, generated).expect("unable to write types.ts");
        println!("✅ TypeScript types generated in shared/");
    }
}
